<!DOCTYPE html>
<html>

<head>
<title>Physijs</title>
        <meta charset=utf-8>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
        </style>

    <script type="text/javascript" src="../js/three.js"></script>
    <script type="text/javascript" src="../js/physi.js"></script>
    <script type="text/javascript" src="../js/OrbitControls.js"></script>

    <script type="text/javascript" src="./ObjetoMovible.js"></script>
    <script type="text/javascript" src="./Asteroide.js"></script>
    <script type="text/javascript" src="./Nave.js"></script>
    <script type="text/javascript" src="./Bala.js"></script>


</head>

<body>
    <div id="viewport"></div>

<script type="text/javascript">

    'use strict';

    Physijs.scripts.worker = '../js/physijs_worker.js';
    Physijs.scripts.ammo = '../js/ammo.js';

    var initScene, render, renderer, scene, camera, box;
    var naveMaterial = new THREE.MeshBasicMaterial({color: 0x000000, wireframe: true});
    var nave = new Nave();
    var box = new Asteroide();

    function createRender(){

        //ponemos color de fondo y el tama√±o de la ventana
        var renderer = new THREE.WebGLRenderer();
        renderer.setClearColor(0xEEEEEE, 1.0);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMapEnabled = true;
        return renderer;
    }

    initScene = function() {
        renderer = createRender();
        document.getElementById( 'viewport' ).appendChild( renderer.domElement );

        scene = new Physijs.Scene;
        scene.setGravity(new THREE.Vector3(0,0,0));  
        scene.addEventListener('update', function() {
            scene.simulate();
        });

        /*camera = new THREE.PerspectiveCamera(
            35,
            window.innerWidth / window.innerHeight,
            1,
            1000
        );
        camera.position.set( 0, 0, 200 );
        */
        camera = new THREE.OrthographicCamera(
            window.innerWidth / - 2, 
            window.innerWidth / 2, 
            window.innerHeight / 2, 
            window.innerHeight / - 2, 
            - 500, 
            1000
        );

        camera.lookAt( scene.position );
        scene.add( camera );
        
        box.position.y = 20;

        var bala = new Bala();
        bala.position.y = 30;
        bala.position.z = -0.5;

        bala.name = "bala";
        nave.name = "nave";
        box.name = "asteroide";
        nave.addEventListener( 'collision', function( other_object, linear_velocity, angular_velocity ) {

            //console.log(nave.name + " " + other_object.name);
            other_object.material.color.setHex( 0xff0000 );
        });
        bala.addEventListener( 'collision', function( other_object, linear_velocity, angular_velocity ) {

            //console.log(bala.name + " " + other_object.name);
            other_object.material.color.setHex( 0xff0000 );
        });
        /*box.addEventListener( 'collision', function( other_object, linear_velocity, angular_velocity ) {

            console.log(box.name + " " + other_object.name);
            other_object.material.color.setHex( 0xff0000 );
        });*/
        
        document.addEventListener('keydown', function(event) {
            if(event.keyCode == 37) { //izquierda
                nave.rotation.z += 0.11;
            }
            else if(event.keyCode == 39) { //derecha
                nave.rotation.z -= 0.11;
                //console.log(nave.rotation.z);
            }
            else if(event.keyCode == 38) { //arriba
                nave.position.x -= 3*Math.sin(nave.rotation.z);
                nave.position.y += 3*Math.cos(nave.rotation.z);
            }
            else if(event.keyCode == 32) { //espacio
                nave.disparar(scene);
            }
        });

        scene.add(nave);
        //scene.add(box);
        //scene.add(bala);

        bala.setCcdMotionThreshold(1);
        bala.setCcdSweptSphereRadius(0.2);
        bala.applyCentralImpulse(new THREE.Vector3(0, -100, 0));
        box.applyCentralImpulse(new THREE.Vector3(0, -100, 0));
        //var controls = new THREE.OrbitControls( camera );
        requestAnimationFrame( render );
    };

    render = function() {
        scene.simulate(); // run physics
        renderer.render( scene, camera); // render the scene
        nave.__dirtyPosition = true;
        nave.__dirtyRotation = true;
        requestAnimationFrame( render );
    };

    window.onload = initScene();

    </script>
</body>
</html>