<!DOCTYPE html>
<html>

<head>
<title>Physijs</title>
        <meta charset=utf-8>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
        </style>

    <script type="text/javascript" src="../js/three.js"></script>
    <script type="text/javascript" src="../js/physi.js"></script>
    <script type="text/javascript" src="../js/OrbitControls.js"></script>

    <script type="text/javascript" src="./ObjetoMovible.js"></script>
    <script type="text/javascript" src="./Asteroide.js"></script>
    <script type="text/javascript" src="./Nave.js"></script>


</head>

<body>
    <div id="viewport"></div>

<script type="text/javascript">

    'use strict';

    Physijs.scripts.worker = '../js/physijs_worker.js';
    Physijs.scripts.ammo = '../js/ammo.js';

    var initScene, render, renderer, scene, camera, box;

    function createRender(){

        //ponemos color de fondo y el tama√±o de la ventana
        var renderer = new THREE.WebGLRenderer();
        renderer.setClearColor(0xEEEEEE, 1.0);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMapEnabled = true;
        return renderer;
    }

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function radianes(grados) {
        return grados * Math.PI / 180;
    }

    function createAsteroide(){

        var squareGeometry = new THREE.CubeGeometry();  
        for (var i = 0; i <= 360; i += getRandomInt(30, 45)) {
            var d = getRandomInt(1.0, 10);
            squareGeometry.vertices.push(new THREE.Vector3( d * Math.cos(radianes(i)), d * Math.sin(radianes(i)), 0.0))
        }
        squareGeometry.vertices.push(new THREE.Vector3( 0.0, 0.0, 0.0));
        
        for (var i = 1; i < squareGeometry.vertices.length; i++) {
            squareGeometry.faces.push(new THREE.Face3(squareGeometry.vertices.length-1 , i, (i + 1)%squareGeometry.vertices.length ));
        }
        return new Physijs.ConcaveMesh(
            squareGeometry,
            new THREE.MeshBasicMaterial({color: 0x000000, wireframe: true}),
            10
        );
    }


    initScene = function() {
        renderer = createRender();
        document.getElementById( 'viewport' ).appendChild( renderer.domElement );

        scene = new Physijs.Scene;
        scene.setGravity(new THREE.Vector3(0,0,0));  
        scene.addEventListener('update', function() {
            scene.simulate();
        });

        camera = new THREE.PerspectiveCamera(
            35,
            window.innerWidth / window.innerHeight,
            1,
            1000
        );
        camera.position.set( 0, 0, 60 );
        camera.lookAt( scene.position );
        scene.add( camera );

        box = new Asteroide();
        
        box.position.y = 20;

        var surface = new Physijs.BoxMesh(
            new THREE.CubeGeometry( 10, 1, 10 ),
            new THREE.MeshBasicMaterial({ color: 0x888888 }),
            0
        );
        surface.name = "surface";
        surface.addEventListener( 'collision', function( other_object, linear_velocity, angular_velocity ) {

            console.log("hemos chocado");
            other_object.material.color.setHex( 0xffffff );
            var selectedObject = scene.getObjectByName("surface");
            scene.remove(selectedObject);
            box.impulsar(100, 100, 0);
        });

        var nave = new Nave();
        nave.position.x = -20;

        document.addEventListener('keydown', function(event) {
            if(event.keyCode == 37) {
                nave.position.x -= 1;
            }
            else if(event.keyCode == 39) {
                nave.position.x += 1;
                nave.reactor.material.opacity = 1.0;
            }
            else if(event.keyCode == 38) {
                nave.rotation.z += 0.1;
            }
        });

        document.addEventListener('keyup', function(event) {
            if(event.keyCode == 37) {
            }
            else if(event.keyCode == 39) {
                nave.reactor.material.opacity = 0.0;
            }
            else if(event.keyCode == 38) {
            }
        });

        scene.add(nave);
        scene.add( surface );
        scene.add( box );
        box.impulsar(0, -100, 0);
        //var controls = new THREE.OrbitControls( camera );
        requestAnimationFrame( render );
    };

    render = function() {
        scene.simulate(); // run physics
        renderer.render( scene, camera); // render the scene
        requestAnimationFrame( render );
    };

    window.onload = initScene();

    </script>
</body>
</html>